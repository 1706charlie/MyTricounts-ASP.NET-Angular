<app-nav-bar title="Signup" backUrl="/login">
</app-nav-bar>

<div class="home-content">
    @if (isLoading) {
        <app-loading-overlay></app-loading-overlay>
    }
    <div class="container text-center signup-wrapper">

        <form [formGroup]="signupForm" (ngSubmit)="signup()" novalidate>

            <!-- Email -->
            <mat-form-field appearance="outline">
                <mat-label>Email</mat-label>
                <input matInput [formControl]="ctlEmail" required appSetFocus>

                @if (ctlEmail.hasError('required')) {
                    <mat-error class="field-error">Required</mat-error>
                }
                @if (ctlEmail.hasError('pattern')) {
                    <mat-error class="field-error">not a valid email</mat-error>
                }
                @if (ctlEmail.hasError('emailUsed')) {
                    <mat-error class="field-error">not available</mat-error>
                }
            </mat-form-field>

            <!-- Full Name -->
            <mat-form-field appearance="outline">
                <mat-label>Full Name</mat-label>
                <input matInput [formControl]="ctlFullName" required>

                @if (ctlFullName.hasError('required')) {
                    <mat-error class="field-error">Required</mat-error>
                }
                @if (ctlFullName.hasError('minlength')) {
                    <mat-error class="field-error">minimum {{ctlFullName.errors?.minlength?.requiredLength}} characters</mat-error>
                }
                @if (ctlFullName.hasError('fullNameUsed')) {
                    <mat-error class="field-error">not available</mat-error>
                }
            </mat-form-field>

            <!-- Iban -->
            <mat-form-field appearance="outline">
                <mat-label>IBAN</mat-label>
                <input matInput [formControl]="ctlIban">

                @if (ctlIban.hasError('pattern')) {
                    <mat-error class="field-error">not a valid IBAN</mat-error>
                }
            </mat-form-field>

            <!-- Password -->
            <mat-form-field appearance="outline">
                <mat-label>Password</mat-label>
                <input type="password" matInput [formControl]="ctlPassword" autocomplete="new-password" required>

                <!-- 1. Required -->
                @if (ctlPassword.hasError('required')) {
                    <mat-error class="field-error">Required</mat-error>
                }

                <!-- 2. Uppercase missing -->
                @else if (ctlPassword.touched && pwdMissingUpper) {
                    <mat-error class="field-error">At least one uppercase letter</mat-error>
                }

                <!-- 3. Digit missing -->
                @else if (ctlPassword.touched && !pwdMissingUpper && pwdMissingDigit) {
                    <mat-error class="field-error">At least one number</mat-error>
                }

                <!-- 4. Special missing -->
                @else if (ctlPassword.touched && !pwdMissingUpper && !pwdMissingDigit && pwdMissingSpecial) {
                    <mat-error class="field-error">At least one special character (@#$!%*?…)</mat-error>
                }

                <!-- 5. Minimum length -->
                @else if (ctlPassword.touched && !pwdMissingUpper && !pwdMissingDigit && !pwdMissingSpecial && pwdTooShort) {
                    <mat-error class="field-error">At least 8 characters</mat-error>
                }
            </mat-form-field>

            <!-- Confirm Password -->
            <mat-form-field appearance="outline">
                <mat-label>Confirm Password</mat-label>
                <input type="password" matInput [formControl]="ctlPasswordConfirm" required>

                <!-- 1. Required -->
                @if (ctlPasswordConfirm.hasError('required')) {
                    <mat-error class="field-error">Required</mat-error>
                }

                <!-- 2. Uppercase missing -->
                @else if (ctlPasswordConfirm.touched && pwdConfMissingUpper) {
                    <mat-error class="field-error">At least one uppercase letter</mat-error>
                }

                <!-- 3. Digit missing -->
                @else if (ctlPasswordConfirm.touched && !pwdConfMissingUpper && pwdConfMissingDigit) {
                    <mat-error class="field-error">At least one number</mat-error>
                }

                <!-- 4. Special missing -->
                @else if (ctlPasswordConfirm.touched && !pwdConfMissingUpper && !pwdConfMissingDigit && pwdConfMissingSpecial) {
                    <mat-error class="field-error">At least one special character (@#$!%*?…)</mat-error>
                }

                <!-- 5. Minimum length -->
                @else if (ctlPasswordConfirm.touched && !pwdConfMissingUpper && !pwdConfMissingDigit && !pwdConfMissingSpecial && pwdConfTooShort) {
                    <mat-error class="field-error">At least 8 characters</mat-error>
                }

                <!-- 6. Passwords do not match -->
                @else if (ctlPasswordConfirm.touched && ctlPasswordConfirm.hasError('passwordsMismatch')) {
                    <mat-error class="field-error">Passwords do not match</mat-error>
                }

            </mat-form-field>
            
            <!-- bouton signup -->
            <div>
                <button 
                    mat-stroked-button 
                    type="submit" 
                    [disabled]="signupForm.invalid || signupForm.pending || isLoading">
                    Sign Up
                </button>
            </div>
            
        </form>
    </div>
</div>


<!--
signupForm.pending = le formulaire est en validation asynchrone (ex: emailUsed()/fullNameUsed()). Pendant cet état, Angular marque le form "PENDING" 
Permet d'éviter que le bouton signup s’active brièvement puis se re‑désactive
-->
